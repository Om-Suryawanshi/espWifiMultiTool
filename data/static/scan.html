<!DOCTYPE html>
<html>
<head>
    <title>Wi-Fi Scanner</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        h1 { text-align: center; }
        #status-message { text-align: center; font-style: italic; color: #555; margin-bottom: 15px;}
        #networks-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #networks-table th, #networks-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #networks-table th { background-color: #f2f2f2; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button { padding: 8px; font-size: 14px; cursor: pointer; }
        #rescan-button { display: block; width: 100%; padding: 10px; font-size: 16px; margin-top: 20px; }
    </style>
</head>

<body>
    <div class="container">
        <h1>Wi-Fi Scan</h1>

        <div id="status-message">Loading...</div>
        <div class="spinner-container" style="display: none;">
            <div class="spinner"></div>
        </div>

        <table id="networks-table">
            <thead>
                <tr>
                    <th>SSID</th>
                    <th>BSSID</th>
                    <th>Channel</th>
                    <th>RSSI</th>
                    <th>Clients</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="networks-list"></tbody>
        </table>

        <button id="rescan-button">Rescan</button>
    </div>

    <script>
        const statusMessage = document.getElementById('status-message');
        const networksList = document.getElementById('networks-list');
        const spinnerContainer = document.querySelector('.spinner-container');
        const rescanButton = document.getElementById('rescan-button');

        async function fetchScanResults() {
            statusMessage.textContent = 'Checking scan status...';
            spinnerContainer.style.display = 'block';
            rescanButton.disabled = true;

            try {
                const response = await fetch('/api/scan');
                const data = await response.json();

                if (response.status === 202) {
                    statusMessage.textContent = 'Scan in progress... This can take up to 15 seconds.';
                    setTimeout(fetchScanResults, 3000); // Poll again after 3 seconds
                } else if (response.ok) {
                    displayNetworks(data.networks);
                    statusMessage.textContent = `Scan complete. Found ${data.networks.length} networks.`;
                    spinnerContainer.style.display = 'none';
                    rescanButton.disabled = false;
                } else {
                    statusMessage.textContent = 'Server error during scan.';
                    spinnerContainer.style.display = 'none';
                    rescanButton.disabled = false;
                }
            } catch (error) {
                statusMessage.textContent = 'Failed to fetch scan results. Please try again.';
                spinnerContainer.style.display = 'none';
                rescanButton.disabled = false;
                console.error('Error fetching data:', error);
            }
        }

        async function startRescan() {
            statusMessage.textContent = 'Sending scan request...';
            rescanButton.disabled = true;
            try {
                const response = await fetch('/api/scan', { method: 'POST' });
                const data = await response.json();
                
                if (data.status === 'scan_req_initiated' || data.status === 'scan_req_processing') {
                    fetchScanResults(); // Start the polling loop
                } else {
                    statusMessage.textContent = 'Failed to start a new scan.';
                    rescanButton.disabled = false;
                }
            } catch (error) {
                statusMessage.textContent = 'Error sending rescan request.';
                rescanButton.disabled = false;
            }
        }
        
        // FIX #2: The OLD displayNetworks function was here and has been DELETED.
        // This is the one, correct version.
        function displayNetworks(networks) {
            networksList.innerHTML = '';
            if (!networks || networks.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center;">No networks found.</td>`;
                networksList.appendChild(row);
                return;
            }

            networks.forEach(network => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${network.ssid}</td>
                    <td>${network.bssid}</td>
                    <td>${network.channel}</td>
                    <td>${network.rssi}</td>
                    <td>${network.clients}</td>
                    <td>
                        <button onclick="deauthNetwork('${network.bssid}', ${network.channel})">Deauth</button>
                    </td>
                `;
                networksList.appendChild(row);
            });
        }

        async function deauthNetwork(bssid, channel) {
            if (!confirm(`Are you sure you want to run a deauth attack on ${bssid}? This is for testing your OWN network only.`)) {
                return;
            }
            
            statusMessage.textContent = `Starting deauth attack on ${bssid}...`;
            spinnerContainer.style.display = 'block';

            try {
                const response = await fetch('/api/deauth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bssid: bssid, channel: channel })
                });
                const data = await response.json();
                if (data.status === 'deauth_started') {
                    statusMessage.textContent = 'Deauth attack initiated. The ESP8266 is now dedicated to the attack and the web server is unresponsive.';
                    // No need to hide spinner, the page is now effectively dead until the ESP8266 is reset
                }
            } catch (error) {
                statusMessage.textContent = 'Failed to start deauth attack. The ESP might have become unresponsive.';
                console.error('Deauth error:', error);
            }
        }

        rescanButton.addEventListener('click', startRescan);
        fetchScanResults(); // Start a scan on page load
    </script>
</body>
</html>