<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Scanner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #2c2c2c;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #444;
        }
        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 2.2rem; color: #00aaff; margin: 0; }
        #status-message { text-align: center; color: #aaa; margin-top: 20px; min-height: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #444; }
        th { background-color: #3a3a3a; white-space: nowrap; }
        tr:hover { background-color: #3f3f3f; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); width: 28px; height: 28px; border-radius: 50%; border-left-color: #00aaff; animation: spin 1s ease infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        button { border: none; border-radius: 5px; padding: 8px 12px; font-size: 14px; cursor: pointer; transition: background-color 0.2s ease; }
        #rescan-button { display: block; width: 100%; padding: 12px; font-size: 16px; margin-top: 20px; background-color: #00aaff; color: white; }
        #rescan-button:disabled { background-color: #555; cursor: not-allowed; }
        .deauth-button { background-color: #ff4444; color: white; }
        .deauth-button:hover { background-color: #e60000; }
        .back-link { display: block; text-align: center; margin-top: 30px; color: #00aaff; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Wi-Fi Scanner & Deauther</h1>
        </header>
        
        <div class="spinner-container" style="display: none;">
            <div class="spinner"></div>
        </div>

        <table id="networks-table">
            <thead>
                <tr>
                    <th>SSID</th>
                    <th>BSSID</th>
                    <th>Ch</th>
                    <th>RSSI</th>
                    <th>Clients</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="networks-list"></tbody>
        </table>
        
        <div id="status-message"></div>
        <button id="rescan-button">Rescan</button>
        <a href="/" class="back-link">‚Üê Back to Dashboard</a>
    </div>

    <script>
        const statusMessage = document.getElementById('status-message');
        const networksList = document.getElementById('networks-list');
        const spinnerContainer = document.querySelector('.spinner-container');
        const rescanButton = document.getElementById('rescan-button');

        async function fetchScanResults() {
            statusMessage.textContent = 'Checking scan status...';
            spinnerContainer.style.display = 'block';
            rescanButton.disabled = true;

            try {
                const response = await fetch('/api/scan');
                const data = await response.json();

                if (response.status === 202) {
                    statusMessage.textContent = 'Scan in progress... This can take up to 15 seconds.';
                    setTimeout(fetchScanResults, 3000);
                } else if (response.ok) {
                    displayNetworks(data.networks);
                    statusMessage.textContent = `Scan complete. Found ${data.networks.length} networks.`;
                    spinnerContainer.style.display = 'none';
                    rescanButton.disabled = false;
                } else {
                    statusMessage.textContent = 'Server error during scan.';
                    spinnerContainer.style.display = 'none';
                    rescanButton.disabled = false;
                }
            } catch (error) {
                statusMessage.textContent = 'Failed to fetch results. The device may be busy. Please wait and try again.';
                spinnerContainer.style.display = 'none';
                rescanButton.disabled = false;
            }
        }

        async function startRescan() {
            statusMessage.textContent = 'Sending scan request...';
            spinnerContainer.style.display = 'block';
            rescanButton.disabled = true;
            try {
                const response = await fetch('/api/scan', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'scan_req_initiated' || data.status === 'scan_req_processing') {
                    fetchScanResults();
                } else {
                    statusMessage.textContent = 'Failed to start a new scan.';
                    rescanButton.disabled = false;
                }
            } catch (error) {
                statusMessage.textContent = 'Error sending rescan request.';
                rescanButton.disabled = false;
            }
        }

        function displayNetworks(networks) {
            networksList.innerHTML = '';
            if (!networks || networks.length === 0) {
                networksList.innerHTML = `<tr><td colspan="6" style="text-align: center;">No networks found.</td></tr>`;
                return;
            }

            networks.forEach(network => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${network.ssid || "<i>Hidden</i>"}</td>
                    <td>${network.bssid}</td>
                    <td>${network.channel}</td>
                    <td>${network.rssi}</td>
                    <td>${network.clients}</td>
                    <td><button class="deauth-button" onclick="deauthNetwork('${network.bssid}', ${network.channel})">Deauth</button></td>
                `;
                networksList.appendChild(row);
            });
        }

        async function deauthNetwork(bssid, channel) {
            if (!confirm(`Are you sure you want to run a deauth attack on ${bssid}?\n\nThis is for testing your OWN network only.`)) {
                return;
            }
            
            statusMessage.textContent = `Starting deauth attack on ${bssid}...`;
            spinnerContainer.style.display = 'block';
            rescanButton.disabled = true;

            try {
                await fetch('/api/deauth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bssid: bssid, channel: channel })
                });
                statusMessage.textContent = 'Deauth attack initiated. The ESP8266 is now dedicated to the attack and the web server is unresponsive.';
            } catch (error) {
                statusMessage.textContent = 'Failed to start deauth attack. The ESP might have become unresponsive.';
            }
        }

        rescanButton.addEventListener('click', startRescan);
        fetchScanResults();
    </script>
</body>
</html>